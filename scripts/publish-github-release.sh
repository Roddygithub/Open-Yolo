#!/bin/bash
# Script de publication automatique de la release GitHub

set -e

# Configuration
REPO_OWNER="Roddygithub"
REPO_NAME="Open-Yolo"

# R√©cup√©rer la version depuis CMakeLists.txt
VERSION=$(grep -A 2 "project(OpenYolo" "${0%/*}/../CMakeLists.txt" | grep "VERSION" | awk '{print $2}')
if [ -z "$VERSION" ]; then
    echo -e "\033[0;31m[ERREUR]\033[0m Impossible de d√©terminer la version depuis CMakeLists.txt"
    exit 1
fi

TAG="v${VERSION}"
RELEASE_TITLE="Open-Yolo v${VERSION} ‚Äì Version stable pour Linux"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${MAGENTA}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                       ‚ïë
‚ïë     üì§ PUBLICATION GITHUB AUTOMATIQUE üì§             ‚ïë
‚ïë                                                       ‚ïë
‚ïë         Open-Yolo v${VERSION} Release                      ‚ïë
‚ïë                                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"
echo ""

log_step() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
}

log_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

log_error() {
    echo -e "${RED}‚úó${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

log_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

# ============================================
# √âTAPE 1 : V√©rification du Token GitHub
# ============================================
log_step "√âTAPE 1/8 : V√©rification du Token GitHub"

if [ -z "$GITHUB_TOKEN" ]; then
    log_error "Variable GITHUB_TOKEN non d√©finie"
    echo ""
    echo -e "${YELLOW}Pour cr√©er un token GitHub :${NC}"
    echo "1. Aller sur : https://github.com/settings/tokens/new"
    echo "2. Nom : Open-Yolo Release"
    echo "3. Permissions : repo (toutes)"
    echo "4. G√©n√©rer le token"
    echo "5. Exporter : export GITHUB_TOKEN=votre_token"
    echo ""
    echo -e "${BLUE}Ou utiliser GitHub CLI :${NC}"
    echo "gh auth login"
    echo ""
    exit 1
fi

log_success "Token GitHub trouv√©"

# V√©rifier l'acc√®s au d√©p√¥t
log_info "V√©rification de l'acc√®s au d√©p√¥t..."
REPO_CHECK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
    "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}" | jq -r '.name // empty')

if [ "$REPO_CHECK" = "$REPO_NAME" ]; then
    log_success "Acc√®s au d√©p√¥t confirm√©"
else
    log_error "Impossible d'acc√©der au d√©p√¥t $REPO_OWNER/$REPO_NAME"
    exit 1
fi
echo ""

# ============================================
# √âTAPE 2 : V√©rification du Tag
# ============================================
log_step "√âTAPE 2/8 : V√©rification du Tag v${VERSION}"

# V√©rifier si le tag existe localement
if git rev-parse "$TAG" >/dev/null 2>&1; then
    log_success "Tag $TAG existe localement"
else
    log_warning "Tag $TAG n'existe pas localement"
    log_info "Cr√©ation du tag..."
    
    git tag -a "$TAG" -m "Open-Yolo v${VERSION} ‚Äì Premi√®re version stable Linux

Fonctionnalit√©s principales :
- Curseurs personnalis√©s et anim√©s (GIF)
- Support multi-√©crans et HiDPI
- Effets visuels (ombre, lueur)
- Interface graphique GTK
- Raccourcis clavier personnalisables
- Rendu GPU optimis√© (< 1% CPU)
- Packaging DEB/RPM/PKGBUILD

Voir CHANGELOG.md pour les d√©tails complets."
    
    log_success "Tag cr√©√©"
fi

# Pousser le tag vers GitHub
log_info "Push du tag vers GitHub..."
if git push origin "$TAG" 2>/dev/null; then
    log_success "Tag pouss√© vers GitHub"
else
    log_warning "Tag d√©j√† pr√©sent sur GitHub ou erreur de push"
fi
echo ""

# ============================================
# √âTAPE 3 : Pr√©paration de la Description
# ============================================
log_step "√âTAPE 3/8 : Pr√©paration de la Description"

DESCRIPTION_FILE="GITHUB_RELEASE_v${VERSION}.md"
if [ -f "$DESCRIPTION_FILE" ]; then
    log_success "Description trouv√©e : $DESCRIPTION_FILE"
    RELEASE_BODY=$(cat "$DESCRIPTION_FILE")
else
    log_warning "Fichier $DESCRIPTION_FILE non trouv√©"
    log_info "Utilisation de la description par d√©faut..."
    RELEASE_BODY="# Open-Yolo v${VERSION}

Premi√®re version stable pour Linux.

Voir CHANGELOG.md pour les d√©tails."
fi
echo ""

# ============================================
# √âTAPE 4 : V√©rification des Artefacts
# ============================================
log_step "√âTAPE 4/8 : V√©rification des Artefacts"

PACKAGES_DIR="packages"
SCREENSHOTS_DIR="docs/screenshots"

# V√©rifier les paquets
if [ ! -d "$PACKAGES_DIR" ] || [ -z "$(ls -A $PACKAGES_DIR 2>/dev/null)" ]; then
    log_warning "Aucun paquet trouv√© dans $PACKAGES_DIR/"
    if [ -f "scripts/build-packages.sh" ]; then
        log_info "Tentative de g√©n√©ration des paquets..."
        ./scripts/build-packages.sh || {
            log_error "√âchec de la g√©n√©ration des paquets. Publication annul√©e."
            exit 1
        }
    else
        log_error "Script 'build-packages.sh' non trouv√©. Impossible de g√©n√©rer les paquets."
        exit 1
    fi
fi

log_success "Paquets disponibles :"
ls -lh "$PACKAGES_DIR" | tail -n +2 | awk '{print "  - " $9 " (" $5 ")"}'

# V√©rifier les captures d'√©cran
if [ -d "$SCREENSHOTS_DIR" ] && [ -n "$(ls -A $SCREENSHOTS_DIR 2>/dev/null)" ]; then
    log_success "Captures d'√©cran disponibles :"
    ls -1 "$SCREENSHOTS_DIR" | sed 's/^/  - /'
else
    log_warning "Aucune capture d'√©cran trouv√©e dans $SCREENSHOTS_DIR/"
fi
echo ""

# ============================================
# √âTAPE 5 : Suppression de l'Ancienne Release
# ============================================
log_step "√âTAPE 5/8 : V√©rification de la Release Existante"

RELEASE_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
    "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/tags/${TAG}" \
    | jq -r '.id // empty')

if [ -n "$RELEASE_ID" ]; then
    log_warning "Release existante trouv√©e (ID: $RELEASE_ID)"
    log_info "Suppression de l'ancienne release..."
    
    curl -s -X DELETE \
        -H "Authorization: token $GITHUB_TOKEN" \
        "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/${RELEASE_ID}"
    
    log_success "Ancienne release supprim√©e"
else
    log_success "Aucune release existante"
fi
echo ""

# ============================================
# √âTAPE 6 : Cr√©ation de la Release
# ============================================
log_step "√âTAPE 6/8 : Cr√©ation de la Release GitHub"

log_info "Cr√©ation de la release..."

# √âchapper le JSON pour la description
RELEASE_BODY_ESCAPED=$(echo "$RELEASE_BODY" | jq -Rs .)

# Cr√©er la release
RELEASE_RESPONSE=$(curl -s -X POST \
    -H "Authorization: token $GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases" \
    -d "{
        \"tag_name\": \"${TAG}\",
        \"name\": \"${RELEASE_TITLE}\",
        \"body\": ${RELEASE_BODY_ESCAPED},
        \"draft\": false,
        \"prerelease\": false,
        \"make_latest\": \"true\"
    }")

RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id // empty')
UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url // empty' | sed 's/{?name,label}//')

if [ -n "$RELEASE_ID" ] && [ -n "$UPLOAD_URL" ]; then
    log_success "Release cr√©√©e (ID: $RELEASE_ID)"
    log_info "URL de release : https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/tag/${TAG}"
else
    log_error "√âchec de cr√©ation de la release"
    echo "$RELEASE_RESPONSE" | jq .
    exit 1
fi
echo ""

# ============================================
# √âTAPE 7 : Upload des Artefacts
# ============================================
log_step "√âTAPE 7/8 : Upload des Artefacts"

upload_asset() {
    local file=$1
    local filename=$(basename "$file")
    
    log_info "Upload de $filename..."
    
    UPLOAD_RESPONSE=$(curl -s -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Content-Type: application/octet-stream" \
        --data-binary @"$file" \
        "${UPLOAD_URL}?name=${filename}")
    
    ASSET_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.id // empty')
    
    if [ -n "$ASSET_ID" ]; then
        log_success "$filename upload√© (ID: $ASSET_ID)"
        return 0
    else
        log_error "√âchec d'upload de $filename"
        echo "$UPLOAD_RESPONSE" | jq .
        return 1
    fi
}

# Upload des paquets
log_info "Upload des paquets..."
for file in "$PACKAGES_DIR"/*; do
    if [ -f "$file" ]; then
        upload_asset "$file"
    fi
done

# Upload des captures d'√©cran
if [ -d "$SCREENSHOTS_DIR" ] && [ -n "$(ls -A $SCREENSHOTS_DIR 2>/dev/null)" ]; then
    log_info "Upload des captures d'√©cran..."
    for file in "$SCREENSHOTS_DIR"/*; do
        if [ -f "$file" ]; then
            upload_asset "$file"
        fi
    done
fi

# Upload du CHANGELOG
if [ -f "CHANGELOG.md" ]; then
    log_info "Upload du CHANGELOG..."
    upload_asset "CHANGELOG.md"
fi

# Upload du PKGBUILD (d√©j√† inclus dans le dossier packages)
# if [ -f "PKGBUILD" ]; then
#     log_info "Upload du PKGBUILD..."
#     upload_asset "PKGBUILD"
# fi

echo ""

# ============================================
# √âTAPE 8 : V√©rification Finale
# ============================================
log_step "√âTAPE 8/8 : V√©rification Finale"

log_info "R√©cup√©ration des informations de la release..."
FINAL_CHECK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
    "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/tags/${TAG}")

ASSETS_COUNT=$(echo "$FINAL_CHECK" | jq '.assets | length')
RELEASE_URL=$(echo "$FINAL_CHECK" | jq -r '.html_url')

log_success "Release publi√©e avec succ√®s !"
log_info "Nombre d'artefacts : $ASSETS_COUNT"
echo ""

# ============================================
# R√âSUM√â FINAL
# ============================================
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  ‚úÖ Publication R√©ussie !${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

echo -e "${BLUE}üìä R√©sum√© de la Release :${NC}"
echo ""
echo -e "  ${YELLOW}Tag :${NC} $TAG"
echo -e "  ${YELLOW}Titre :${NC} $RELEASE_TITLE"
echo -e "  ${YELLOW}Artefacts :${NC} $ASSETS_COUNT fichiers"
echo -e "  ${YELLOW}URL :${NC} $RELEASE_URL"
echo ""

echo -e "${BLUE}üì¶ Artefacts Inclus :${NC}"
echo "$FINAL_CHECK" | jq -r '.assets[] | "  - \(.name) (\(.size / 1024 / 1024 | floor)MB)"'
echo ""

echo -e "${BLUE}üîó Liens :${NC}"
echo -e "  ${CYAN}Release :${NC} $RELEASE_URL"
echo -e "  ${CYAN}T√©l√©chargements :${NC} https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/download/${TAG}/"
echo ""

echo -e "${MAGENTA}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${MAGENTA}  üéâ Release v${VERSION} Publi√©e ! üéâ${NC}"
echo -e "${MAGENTA}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
